# 노드 위치 저장 기능 테스트 가이드

## 수정 사항 요약

### 1. 드래그 종료 시 위치 저장
- **변경**: `handleNodeDragEnd`에서 `lockedIds` 체크 제거
- **이유**: 새로 생성된 노드도 `lockedIds`에 포함되어 있어서 저장이 안됨
- **해결**: 동심원 고정 노드(`radialAnchors`)만 제외하고 모두 저장

### 2. 새 노드 생성 시 자동 저장
- **추가**: `addNode` 함수에 2초 후 자동 위치 저장 로직 추가
- **이유**: 물리 시뮬레이션이 안정화된 후 위치를 저장해야 함
- **로직**: `setTimeout(() => { ... }, 2000)`

### 3. State 업데이트 최적화
- **변경**: `saveNodePositions`에서 함수형 업데이트 사용
- **이유**: `savedNodePositions`를 의존성에서 제거하여 무한 루프 방지
- **해결**: `setSavedNodePositions(prevPositions => { ... })`

### 4. 디버깅 로그 추가
- 📍 노드 위치 로드 완료
- 🎯 드래그 종료 감지
- 💾 노드 위치 저장
- 🆕 새 노드 위치 자동 저장
- ⚠️ 경고/에러 메시지

---

## 테스트 시나리오

### ✅ 테스트 1: 기존 노드 드래그
1. 브라우저에서 앱 실행
2. 개발자 도구 콘솔 열기 (F12)
3. 기존 노드(Core가 아닌 노드) 하나를 드래그
4. 마우스 버튼 놓기 (드래그 종료)
5. **예상 결과**:
   ```
   🎯 드래그 종료 감지: [노드ID] (x: 123.4, y: -56.7)
   💾 노드 위치 저장: [노드ID] (x: 123.4, y: -56.7)
   ```
6. 페이지 새로고침 (F5)
7. **예상 결과**: 노드가 드래그한 위치에 그대로 있음

### ✅ 테스트 2: 새 노드 생성
1. "+" 버튼 클릭하여 새 노드 생성
2. 모달에서 제목 입력 후 "Add Node" 클릭
3. 2초 대기
4. **예상 결과**:
   ```
   🆕 새 노드 위치 자동 저장: [새노드ID]
   💾 노드 위치 저장: [새노드ID] (x: 123.4, y: -56.7)
   ```
5. 페이지 새로고침 (F5)
6. **예상 결과**: 새 노드가 생성된 위치에 그대로 있음

### ✅ 테스트 3: 새 노드 생성 후 드래그
1. 새 노드 생성 (위와 동일)
2. 생성된 노드를 다른 위치로 드래그
3. 마우스 버튼 놓기
4. **예상 결과**:
   ```
   🎯 드래그 종료 감지: [새노드ID] (x: 456.7, y: -89.0)
   💾 노드 위치 저장: [새노드ID] (x: 456.7, y: -89.0)
   ```
5. 페이지 새로고침 (F5)
6. **예상 결과**: 노드가 드래그한 최종 위치에 있음

### ✅ 테스트 4: localStorage 확인
1. 브라우저 콘솔에서 실행:
   ```javascript
   JSON.parse(localStorage.getItem('graphNodePositions'))
   ```
2. **예상 결과**: 저장된 노드 위치 객체 출력
   ```javascript
   {
     "node1": { x: 123.45, y: -67.89 },
     "node2": { x: 456.78, y: -90.12 },
     ...
   }
   ```

### ⚠️ 테스트 5: Core 노드는 저장 안됨
1. Core 노드(중앙 고정 노드)를 드래그 시도
2. **예상 결과**: Core는 동심원 고정이라 드래그 불가능
3. 만약 드래그 가능한 동심원 노드가 있다면:
   ```
   ⚠️ 동심원 고정 노드는 위치 저장 안함: Core
   ```

---

## 문제 해결 가이드

### 문제 1: 콘솔에 로그가 전혀 안 나옴
- **원인**: 앱이 실행되지 않았거나 콘솔 필터 설정
- **해결**: 
  1. 터미널에서 `npm run dev` 확인
  2. 브라우저 콘솔 필터 확인 (All levels 선택)

### 문제 2: "드래그 종료 감지" 로그는 나오지만 "노드 위치 저장" 로그가 안 나옴
- **원인**: 400ms 디바운스 타이머가 작동 중
- **해결**: 드래그 종료 후 0.5초 대기

### 문제 3: 새로고침 후 노드 위치가 리셋됨
- **원인**: localStorage 저장 실패 또는 로드 실패
- **해결**: 
  1. 콘솔에서 localStorage 확인
  2. "📍 노드 위치 로드 완료" 로그 확인
  3. 브라우저 시크릿 모드에서는 localStorage가 제한될 수 있음

### 문제 4: "node가 없음" 경고 발생
- **원인**: `onNodeDragEnd`가 `null` 또는 `undefined` 받음
- **해결**: 
  1. `react-force-graph-2d` 버전 확인
  2. `ForceGraph2D`의 `onNodeDragEnd` prop 연결 확인

---

## 코드 변경 위치

### c:\Users\tjrgk\Desktop\Git\graph_note\src\App.jsx

1. **Line ~330**: `saveNodePositions` - 함수형 업데이트로 변경
2. **Line ~350**: `scheduleSavePositions` - 400ms 디바운스
3. **Line ~410**: `addNode` - 2초 후 자동 저장 추가
4. **Line ~430**: `handleNodeDragEnd` - lockedIds 체크 제거, 로그 추가

---

## 성공 기준

✅ 모든 테스트 시나리오 통과  
✅ 콘솔에 예상 로그 출력  
✅ localStorage에 위치 데이터 저장 확인  
✅ 새로고침 후 노드 위치 유지  
✅ React 경고/에러 없음  

---

## 추가 개선 사항 (선택)

1. **위치 저장 애니메이션**: 저장 시 노드에 깜빡임 효과
2. **저장 실패 알림**: localStorage quota 초과 시 사용자 알림
3. **위치 초기화 버튼**: 모든 노드 위치 리셋 기능
4. **서버 동기화**: 브라우저 간 위치 공유
